<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Chat Room</title>
    <link href="/webjars/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="/bootstrap-icons-1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .emoji {
            font-size: 1.4em;
            cursor: pointer;
            padding: 3px;
            transition: 0.2s;
            border-radius: 5px;
        }

        .emoji:hover {
            background-color: #f0f0f0;
        }

        .emoji-option {
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.1s ease;
        }

        .emoji-option:hover {
            transform: scale(1.2);
        }

        .avatar-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #dee2e6;
            color: #212529;
            text-align: center;
            line-height: 40px;
            font-weight: bold;
            font-size: 18px;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .chat-message {
            display: flex;
        }

        .message-bubble {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-radius: 10px;
            max-width: 75%;
            word-wrap: break-word;
        }

        .message-bubble strong {
            color: #0d6efd;
        }
        .highlight-msg {
            background-color: #d0ebff !important;
            border-left: 4px solid #339af0;
        }
        #notification-list li {
            font-size: 0.9rem;
        }
        .nav-link {
            transition: background-color 0.3s ease, color 0.3s ease;
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
        }

        .nav-link.active {
            background-color: #0d6efd !important; /* Bootstrap primary */
            color: #fff !important;
            font-weight: 500;
        }

        .nav-link:hover {
            background-color: #e9ecef;
            color: #0d6efd;
        }
        .nav-item {
            margin-bottom: 0.25rem;
        }
    </style>

</head>


<body class="bg-light">
<div class="d-flex">
    <!-- Sidebar -->
    <div class="bg-white border-end shadow-sm" style="width: 240px; min-height: 100vh;">
        <div class="p-3 border-bottom">
            <h5 class="mb-0 text-primary">üì° Insight Monitor</h5>
        </div>
        <ul class="nav flex-column p-2">
            <li class="nav-item mb-1">
                <a th:href="@{/dashboard}"
                   th:classappend="${requestUri.startsWith('/dashboard')} ? 'active text-white' : 'text-dark'"
                   class="nav-link d-flex align-items-center">
                    <i class="bi bi-chat-left-dots me-2"></i> Dashboard
                </a>
            </li>
            <li class="nav-item mb-1">
                <a th:href="@{/raw}"
                   th:classappend="${requestUri.startsWith('/raw')} ? 'active text-white' : 'text-dark'"
                   class="nav-link d-flex align-items-center">
                    <i class="bi bi-people me-2"></i> Raw View
                </a>
            </li>
            <li class="nav-item mb-1">
                <a th:href="@{/feign-logs}"
                   th:classappend="${requestUri.startsWith('/feign-logs')} ? 'active text-white' : 'text-dark'"
                   class="nav-link d-flex align-items-center">
                    <i class="bi bi-graph-up-arrow me-2"></i> Feign Logs
                </a>
            </li>
            <li class="nav-item mb-1">
                <a th:href="@{/chat}"
                   th:classappend="${requestUri.startsWith('/chat')} ? 'active text-white' : 'text-dark'"
                   class="nav-link d-flex align-items-center">
                    <i class="bi bi-chat-dots me-2"></i> Internal Chat
                </a>
            </li>
            <li class="nav-item mb-1">
                <a th:href="@{/architecture}"
                   th:classappend="${requestUri.startsWith('/architecture')} ? 'active text-white' : 'text-dark'"
                   class="nav-link d-flex align-items-center">
                    <i class="bi bi-diagram-3 me-2"></i> Architecture
                </a>
            </li>
            <li class="nav-item mt-3">
                <a href="#" class="nav-link text-danger d-flex align-items-center">
                    <i class="bi bi-box-arrow-right me-2"></i> Logout
                </a>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="flex-grow-1 p-4">
        <!-- Chat ho·∫∑c m√†n h√¨nh ch√≠nh hi·ªÉn th·ªã ·ªü ƒë√¢y -->
        <h3>üëã Welcome to Chat Monitor</h3>
        <p class="text-muted">T·ªïng quan v√† nh·∫≠t k√Ω ho·∫°t ƒë·ªông t·ª´ h·ªá th·ªëng chat.</p>
        <div class="row mb-3">
            <div class="col-md-4">
                <input type="text" id="nickname" class="form-control" placeholder="Enter your nickname">
            </div>
            <div class="col-md-4">
                <input type="text" id="room" class="form-control" placeholder="Enter room name">
            </div>
            <div class="col-md-4">
                <button onclick="connect()" class="btn btn-primary">Join Room</button>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card mb-3">
                    <!-- Search bar -->
                    <div class="input-group">
                        <input type="text" class="form-control" id="search-input" placeholder="Search message..."
                               oninput="searchMessages()">
                        <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">X</button>
                    </div>
                    <div class="card-body" id="chat-box" style="height: 500px; overflow-y: auto; background: #f5f5f5">
                        <div th:each="msg : ${history}" class="chat-message d-flex align-items-start mb-2">
                            <!-- Avatar -->
                            <div class="avatar-circle me-2 d-flex align-items-center justify-content-center text-white"
                                 style="width: 40px; height: 40px; border-radius: 50%; font-weight: bold; background-color: #6c757d;">
                                <span th:text="${msg.sender != null ? msg.sender.substring(0, 1).toUpperCase() : '?'}">A</span>
                            </div>

                            <!-- Message Bubble -->
                            <div class="message-bubble bg-light p-2 rounded" style="max-width: 400px; word-break: break-word;">

                                <!-- Quote (Tr√≠ch d·∫´n tin nh·∫Øn kh√°c) -->
                                <div th:if="${msg.quote != null}"
                                     class="bg-white border-start border-4 ps-2 mb-2 text-muted small"
                                     style="border-color: #0d6efd;">
                                    <strong th:text="${msg.quote}">Quoted Sender</strong><br/>
                                    <span th:text="${msg.quote}">Quoted message...</span>
                                </div>

                                <!-- N·∫øu l√† ·∫£nh -->
                                <div th:if="${msg.content != null and msg.content.startsWith('data:image')}">
                                    <img th:src="${msg.content}" class="img-fluid rounded" style="max-width: 200px;"
                                         alt="image"/>
                                </div>

                                <!-- N·∫øu l√† file -->
                                <div th:if="${msg.content != null and msg.type == 'file'}">
                                    <strong th:text="${msg.sender}">Sender</strong><br/>

                                    <!-- PDF -->
                                    <i th:if="${msg.fileName != null and #strings.endsWith(msg.fileName.toLowerCase(), '.pdf')}"
                                       class="bi bi-file-earmark-pdf text-danger"></i>

                                    <!-- ZIP / RAR -->
                                    <i th:if="${msg.fileName != null and (#strings.endsWith(msg.fileName.toLowerCase(), '.zip')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.rar'))}"
                                       class="bi bi-file-earmark-zip text-secondary"></i>

                                    <!-- Word DOC / DOCX -->
                                    <i th:if="${msg.fileName != null and (#strings.endsWith(msg.fileName.toLowerCase(), '.doc')
                                or #strings.endsWith(msg.fileName.toLowerCase(), '.docx'))}"
                                       class="bi bi-file-earmark-word text-primary"></i>

                                    <!-- Excel XLS / XLSX -->
                                    <i th:if="${msg.fileName != null and (#strings.endsWith(msg.fileName.toLowerCase(), '.xls')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.xlsx'))}"
                                       class="bi bi-file-earmark-excel text-success"></i>

                                    <!-- PowerPoint PPT / PPTX -->
                                    <i th:if="${msg.fileName != null and (#strings.endsWith(msg.fileName.toLowerCase(), '.ppt')
                             or #strings.endsWith(msg.fileName.toLowerCase(), '.pptx'))}"
                                       class="bi bi-file-earmark-ppt text-warning"></i>

                                    <!-- Text files -->
                                    <i th:if="${msg.fileName != null and (#strings.endsWith(msg.fileName.toLowerCase(), '.txt')
                             or #strings.endsWith(msg.fileName.toLowerCase(), '.md'))}"
                                       class="bi bi-file-earmark-text"></i>

                                    <!-- Image files -->
                                    <i th:if="${msg.fileName != null and (#strings.endsWith(msg.fileName.toLowerCase(), '.png')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.jpg')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.jpeg')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.gif')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.bmp'))}"
                                       class="bi bi-file-earmark-image text-info"></i>

                                    <!-- Audio files -->
                                    <i th:if="${msg.fileName != null and (#strings.endsWith(msg.fileName.toLowerCase(), '.mp3')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.wav')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.ogg'))}"
                                       class="bi bi-file-earmark-music text-muted"></i>

                                    <!-- Video files -->
                                    <i th:if="${msg.fileName != null and (#strings.endsWith(msg.fileName.toLowerCase(), '.mp4')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.mov')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.avi'))}"
                                       class="bi bi-file-earmark-play text-muted"></i>

                                    <!-- M·∫∑c ƒë·ªãnh -->
                                    <i th:if="${msg.fileName == null or !(
                            #strings.endsWith(msg.fileName.toLowerCase(), '.pdf')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.zip')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.rar')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.doc')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.docx')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.xls')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.xlsx')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.ppt')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.pptx')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.txt')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.md')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.png')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.jpg')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.jpeg')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.gif')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.bmp')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.mp3')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.wav')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.ogg')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.mp4')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.mov')
                            or #strings.endsWith(msg.fileName.toLowerCase(), '.avi')
                        )}"
                                       class="bi bi-file-earmark"></i>

                                    <a th:href="${msg.content}" th:download="${msg.fileName}"
                                       th:text="${msg.fileName ?: 'T·ªáp ƒë√≠nh k√®m'}"
                                       target="_blank"></a>
                                </div>

                                <!-- N·∫øu l√† tin nh·∫Øn vƒÉn b·∫£n -->
                                <div th:if="${msg.content != null and (msg.type == null or msg.type != 'file') and !msg.content.startsWith('data:image')}">
                                    <strong th:text="${msg.sender}">Sender</strong><br/>
                                    <span th:text="${msg.content}">Text content</span>
                                </div>

                                <!-- Reaction (Bi·ªÉu c·∫£m) -->
                                <div th:if="${msg.reactions != null and !msg.reactions.isEmpty()}" class="mt-2">
                                    <div class="d-flex gap-1 flex-wrap">
                                <span th:each="reaction : ${msg.reactions.entrySet()}"
                                      class="badge bg-secondary rounded-pill px-2 py-1 small"
                                      style="font-size: 0.9rem;">
                                    <span th:text="${reaction.key}">üëç</span>
                                    <span th:if="${reaction.value > 1}" th:text="' ' + ${reaction.value}"> 2</span>
                                </span>
                                    </div>
                                </div>


                                <!-- Th·ªùi gian g·ª≠i -->
                                <div class="text-muted small mt-1" th:if="${msg.timestamp != null}"
                                     th:text="${#temporals.format(msg.timestamp, 'HH:mm dd/MM/yyyy')}">
                                    14:30 01/07/2025
                                </div>

                            </div>
                        </div>

                    </div>
                </div>

                <!-- typing indicator -->
                <div id="typing-indicator" style="font-style: italic; color: gray; margin-bottom: 5px;"></div>
                <!-- Quote Preview (Reply to message) -->
                <div id="quote-preview" class="border p-2 mb-2 rounded bg-light d-none">
                    <div><strong id="quote-user"></strong>: <span id="quote-text"></span></div>
                    <button class="btn btn-sm btn-link text-danger" onclick="cancelQuote()">Cancel</button>
                </div>
                <!-- Giao di·ªán g·ª≠i tin -->
                <div class="input-group mt-3">
                    <input type="text" id="message" class="form-control" placeholder="Type your message...">
                    <input type="hidden" id="quote-content"/>
                    <!-- N√∫t m·ªü emoji -->
                    <button id="emoji-btn" class="btn btn-outline-secondary">üòä</button>

                    <!-- Emoji Picker -->
                    <div id="emoji-picker" class="border rounded p-2 bg-white shadow"
                         style="display: none; position: absolute; right: 0; bottom: 60px; z-index: 1000; width: 250px; max-height: 200px; overflow-y: auto;">
                        <!-- D√†n emoji -->
                        <div id="emoji-container" style="display: flex; flex-wrap: wrap; gap: 5px;"></div>
                    </div>

                    <!-- Image only -->
                    <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="sendImage(this)">
                    <button class="btn btn-outline-secondary" onclick="document.getElementById('imageInput').click()">
                        <i class="bi bi-image"></i>
                    </button>

                    <!-- All files -->
                    <input type="file" id="fileInput" style="display: none;" onchange="sendFile(this)">
                    <button class="btn btn-outline-secondary" onclick="document.getElementById('fileInput').click()">
                        <i class="bi bi-paperclip"></i>
                    </button>


                    <button onclick="sendMessage()" class="btn btn-primary">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
            </div>

            <!-- user list -->
            <div class="col-md-4">
                <!-- Th√¥ng b√°o -->
                <div class="card">
                    <div class="card-header d-flex align-items-center">
                        <i class="bi bi-bell-fill text-primary me-2"></i>
                        <strong>Th√¥ng b√°o h·ªá th·ªëng</strong>
                    </div>
                    <ul class="list-group list-group-flush" id="notification-list" style="height: 300px; overflow-y: auto;">
                        <!-- C√°c th√¥ng b√°o s·∫Ω ƒë∆∞·ª£c append ·ªü ƒë√¢y -->
                    </ul>
                </div>
                <div class="card mt-3">
                    <div class="card-header">
                        üë• Online Users (<span id="user-count">0</span>)
                    </div>
                    <ul class="list-group list-group-flush" style="height: 135px; overflow-y: auto;" id="user-list">
                        <!-- nicknames here -->
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Emoji popup -->
<div id="emoji-popup" class="card p-2 position-absolute shadow-sm" style="display: none; z-index: 999;">
    <div class="d-flex gap-2">
        <span class="emoji-option" onclick="sendReaction('üëç')">üëç</span>
        <span class="emoji-option" onclick="sendReaction('‚ù§Ô∏è')">‚ù§Ô∏è</span>
        <span class="emoji-option" onclick="sendReaction('üòÇ')">üòÇ</span>
        <span class="emoji-option" onclick="sendReaction('üòÆ')">üòÆ</span>
        <span class="emoji-option" onclick="sendReaction('üò¢')">üò¢</span>
        <span class="emoji-option" onclick="sendReaction('üò°')">üò°</span>
    </div>
</div>
<!-- Toast Container -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1050">
    <div id="custom-toast" class="toast align-items-center text-white bg-primary border-0" role="alert"
         aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="toast-message">
                <!-- N·ªôi dung toast s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t ·ªü ƒë√¢y -->
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                    aria-label="Close"></button>
        </div>
    </div>
</div>

<!-- Loading Button (Top-Right Corner) -->
<div id="global-loading-indicator"
     class="position-fixed top-0 end-0 p-3"
     style="z-index: 1050; display: none;">
    <div class="spinner-border text-primary" role="status" style="width: 1.5rem; height: 1.5rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<script src="/webjars/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="/webjars/stomp-websocket/2.3.4/stomp.min.js"></script>
<script src="/js/bootstrap.bundle.min.js"></script>
<script>

    window.addEventListener("DOMContentLoaded", () => {
        const chatBox = document.getElementById("chat-box");
        chatBox.scrollTo({
            top: chatBox.scrollHeight,
            behavior: 'smooth' // üëà Cu·ªôn m∆∞·ª£t
        });
    });

    let stompClient = null;
    let currentRoom = "";

    let connected = false;

    let typingTimeout;

    function searchMessages() {
        const keyword = document.getElementById("search-input").value.toLowerCase();
        const messages = document.querySelectorAll("#chat-box .chat-message");

        let firstMatch = null;

        messages.forEach(msg => {
            const contentEl = msg.querySelector(".message-bubble");
            const contentText = contentEl?.innerText.toLowerCase() || "";

            if (keyword && contentText.includes(keyword)) {
                contentEl.classList.add("highlight-msg");
                if (!firstMatch) firstMatch = msg;
            } else {
                contentEl?.classList.remove("highlight-msg");
            }
        });

        if (firstMatch) {
            firstMatch.scrollIntoView({behavior: "smooth", block: "center"});
        }
    }

    function clearSearch() {
        document.getElementById("search-input").value = "";
        searchMessages(); // clear highlight
    }


    document.getElementById("message").addEventListener("paste", function (event) {
        const items = event.clipboardData.items;
        for (const item of items) {
            if (item.type.indexOf("image") === 0) {
                const file = item.getAsFile();
                const reader = new FileReader();
                reader.onload = function (e) {
                    const base64Image = e.target.result;
                    const sender = document.getElementById("nickname").value;
                    const room = document.getElementById("room").value;

                    stompClient.send(`/app/chat/${room}`, {}, JSON.stringify({
                        sender: sender,
                        content: base64Image,
                        room: room,
                        type: "image"
                    }));

                };
                reader.readAsDataURL(file);
            }
        }
    });



    document.getElementById("message").addEventListener("input", function () {
        const sender = document.getElementById("nickname").value;
        const room = document.getElementById("room").value;

        stompClient.send(`/app/chat/${room}/typing`, {}, JSON.stringify({sender, room}));

        // G·ª≠i typing m·ªói 3s n·∫øu ti·∫øp t·ª•c g√µ
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            stompClient.send(`/app/chat/${room}/typing`, {}, JSON.stringify({sender: ""}));
        }, 3000);
    });


    // Helper: L·∫•y query param t·ª´ URL
    function getQueryParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
    }

    document.addEventListener("DOMContentLoaded", () => {
        const roomInput = document.getElementById("room");
        const urlRoom = getQueryParam("room");
        const savedRoom = localStorage.getItem("chatRoom");

        // ∆Øu ti√™n room tr√™n URL, n·∫øu kh√¥ng c√≥ th√¨ d√πng localStorage
        if (urlRoom) {
            roomInput.value = urlRoom;
            localStorage.setItem("chatRoom", urlRoom); // l∆∞u l·∫°i cho l·∫ßn sau
        } else if (savedRoom) {
            roomInput.value = savedRoom;
        }
    });

    function connect() {
        if (connected) return; // tr√°nh g·ªçi l·∫°i connect nhi·ªÅu l·∫ßn

        const nickname = document.getElementById("nickname").value;
        const room = document.getElementById("room").value;

        // ‚úÖ Ki·ªÉm tra nickname v√† room ph·∫£i kh√°c null / r·ªóng
        if (!nickname || !room) {
            showToast("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n v√† ph√≤ng!", true);
            return;
        }

        currentRoom = room;

        localStorage.setItem("chatRoom", room); // l∆∞u l·∫°i ph√≤ng
        history.pushState(null, "", `/chat?room=${encodeURIComponent(room)}`);

        const socket = new SockJS("/ws");
        stompClient = Stomp.over(socket);
        stompClient.connect({}, () => {

            // ‚úÖ G·ª≠i s·ª± ki·ªán join ƒë·ªÉ th√™m user
            stompClient.send(`/app/chat/${room}/join`, {}, JSON.stringify({
                sender: nickname,
                room: room
            }));

            // ‚úÖ V·∫´n gi·ªØ tin nh·∫Øn ch√†o m·ª´ng ƒë·ªÉ hi·ªán ra giao di·ªán
            stompClient.send(`/app/chat/${room}`, {}, JSON.stringify({
                sender: "System",
                content: `${nickname} has joined the room!`,
                room: room
            }));

            stompClient.subscribe(`/topic/${room}`, (message) => {
                const msg = JSON.parse(message.body);
                console.log(message.body, msg)
                showMessage(msg.content, msg.sender, msg.timestamp, msg.type, msg.fileName, msg.quote, msg.id, msg.reactions); // ‚è∞ th√™m timestamp

                if (msg.sender !== nickname) {
                    notify("New message from " + msg.sender);
                    notifyNewMessage(msg.sender);
                }
            });

            stompClient.subscribe(`/topic/${room}/typing`, (msg) => {
                const typingUser = msg.body;
                const indicator = document.getElementById("typing-indicator");

                if (typingUser && typingUser !== nickname) {
                    indicator.innerText = `${typingUser} is typing...`;
                    clearTimeout(typingTimeout);
                    typingTimeout = setTimeout(() => indicator.innerText = "", 1000);
                } else {
                    indicator.innerText = "";
                }
            });

            stompClient.subscribe(`/topic/${room}/users`, (msg) => {
                const users = JSON.parse(msg.body);
                document.getElementById("user-count").innerText = users.length;

                const list = document.getElementById("user-list");
                list.innerHTML = "";
                users.forEach(u => {
                    const li = document.createElement("li");
                    li.className = "list-group-item";
                    li.innerText = u;
                    list.appendChild(li);
                });
            });

            stompClient.subscribe("/topic/alerts", function (messageOutput) {
                appendNotification(messageOutput.body, "danger");
            });

            connected = true; // ƒë√°nh d·∫•u ƒë√£ k·∫øt n·ªëi
        });
    }

    document.getElementById("message").addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
            sendMessage();
            event.preventDefault();
        }
    });

    document.getElementById("nickname").addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
            connect();
            event.preventDefault();
        }
    });

    function sendImage(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
            const base64Image = e.target.result;
            const sender = document.getElementById("nickname").value;
            const room = document.getElementById("room").value;

            stompClient.send(`/app/chat/${room}`, {}, JSON.stringify({
                sender: sender,
                content: base64Image,
                room: room,
                type: "image"
            }));
        };
        reader.readAsDataURL(file);

        // Reset input to allow re-uploading the same file
        input.value = '';
    }

    function sendFile(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
            const base64Content = e.target.result;
            const sender = document.getElementById("nickname").value;
            const room = document.getElementById("room").value;

            stompClient.send(`/app/chat/${room}`, {}, JSON.stringify({
                sender: sender,
                room: room,
                type: "file",
                fileName: file.name,
                fileType: file.type,
                content: base64Content
            }));
        };
        reader.readAsDataURL(file); // read as base64

        input.value = '';
    }

    function clearQuote() {
        document.getElementById("quote-preview").style.display = "none";
        document.getElementById("quote-content").value = "";
    }

    function quoteFromElement(el) {
        const content = el.getAttribute("data-quote");
        const sender = el.getAttribute("data-sender");
        const type = el.getAttribute("data-type");

        quoteMessage(content, sender, type);
    }


    function quoteMessage(content, sender, type, fileName = '') {
        document.getElementById("quote-preview").classList.remove("d-none");
        const messageInput = document.getElementById("message");
        const preview = document.getElementById("quote-preview");
        const quoteText = document.getElementById("quote-text");
        const quoteHidden = document.getElementById("quote-content");

        let html = `<div class="border-start border-4 ps-2 text-muted small">`;

        html += `<strong>${sender}</strong><br/>`;

        if (type === 'image' || content.startsWith("data:image")) {
            html += `<img src="${content}" style="max-width: 100px;" class="img-thumbnail"/>`;
        } else if (type === 'file' || content.startsWith("data:")) {
            html += `<i class="bi bi-paperclip"></i> ${fileName || "T·ªáp ƒë√≠nh k√®m"}`;
        } else {
            html += `<span>${content}</span>`;
        }

        html += `</div>`;

        preview.innerHTML = html + `<button class="btn btn-sm btn-link text-danger" onclick="clearQuote()">H·ªßy</button>`;
        preview.style.display = "block";

        // Truy·ªÅn quote text plain v√†o hidden input ƒë·ªÉ server nh·∫≠n
        quoteHidden.value = (type === 'text') ? content : `[${type} from ${sender}]`;
        messageInput.focus(); // üëà focus l·∫°i v√†o √¥ nh·∫≠p
    }


    function sendMessage() {
        const messageInput = document.getElementById("message");
        const content = messageInput.value.trim();
        const sender = document.getElementById("nickname").value;
        const room = document.getElementById("room").value;
        const quote = document.getElementById("quote-content").value;


        if (!content || !sender || !room) {
            showToast("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!", true);
            return;
        }

        stompClient.send(`/app/chat/${room}`, {}, JSON.stringify({
            sender: sender,
            content: content,
            room: room,
            quote: quote || null  // C√≥ th·ªÉ l√† text, ho·∫∑c object n·∫øu mu·ªën n√¢ng cao
        }));

        messageInput.value = "";
        messageInput.focus(); // üëà focus l·∫°i v√†o √¥ nh·∫≠p
        clearQuote();
    }

    function showMessage(text, sender, timestamp, type = 'text', fileName = '', quote = '', id = 0, reactions = {}) {
        const chatBox = document.getElementById("chat-box");

        // T√¨m xem ƒë√£ c√≥ message n√†y ch∆∞a
        let messageDiv = document.getElementById("message-" + id);
        if (!messageDiv) {
            messageDiv = document.createElement("div");
            messageDiv.className = "chat-message d-flex align-items-start mb-2";
            messageDiv.id = "message-" + id;
            chatBox.appendChild(messageDiv);
        }

        const avatar = `<div class="avatar-circle me-2 d-flex align-items-center justify-content-center text-white"
        style="width: 40px; height: 40px; border-radius: 50%; font-weight: bold; background-color: #6c757d;">
        ${sender.charAt(0).toUpperCase()}
    </div>`;

        let formattedTime = "";
        if (timestamp) {
            const date = new Date(timestamp);
            const timeStr = date.toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit'
            });
            const dateStr = date.toLocaleDateString('vi-VN'); // ƒë·ªãnh d·∫°ng ng√†y/th√°ng/nƒÉm
            formattedTime = `<div class="text-muted small mt-1">${timeStr} ${dateStr}</div>`;
        }

        let bubbleContent = "";

        // Quote
        if (quote) {
            bubbleContent += `<div class="bg-white border-start border-4 ps-2 mb-1 text-muted small">${quote}</div>`;
        }

        // N·ªôi dung
        if (text.startsWith("data:image")) {
            bubbleContent += `<img src="${text}" class="img-fluid rounded" style="max-width: 200px;" alt="image" />`;
        } else if (text.startsWith("data:")) {
            const mimeType = text.substring(5, text.indexOf(";"));
            const icon = getIconForMimeType(mimeType);
            bubbleContent += `
        <strong>${sender}</strong><br>
        <i class="bi ${icon} me-1"></i>
        <a href="${text}" download="${fileName}" target="_blank">${fileName || "T·ªáp ƒë√≠nh k√®m"}</a>
        `;
        } else {
            bubbleContent += `<strong>${sender}</strong><br><span>${text}</span>`;
        }

        // Emoji reactions n·∫øu c√≥
        if (reactions && Object.keys(reactions).length > 0) {
            bubbleContent += `<div class="mt-1">`;
            for (const [emoji, count] of Object.entries(reactions)) {
                bubbleContent += `<span class="me-1"><span class="emoji">${emoji}</span> <small class="text-muted">${count}</small></span>`;
            }
            bubbleContent += `</div>`;
        }

        // Buttons
        bubbleContent += `
        <div class="mt-2 d-flex gap-2">
            <a href="#" class="text-decoration-none text-primary small"
               data-quote="${text.replace(/"/g, '&quot;')}"
               data-sender="${sender}"
               data-type="${type}"
               data-filename="${fileName || ''}"
               onclick="quoteFromElement(this)">
                <i class="bi bi-reply"></i> Reply
            </a>

            <a href="#" class="text-decoration-none text-muted small" onclick="reactToMessage('${id}', event)">
                <i class="bi bi-emoji-smile"></i> React
            </a>
            <a href="#"
               class="text-decoration-none text-success small"
               data-copy="${text.replace(/"/g, '&quot;')}"
               data-type="${type}"
               data-filename="${fileName || ''}"
               onclick="copyFromElement(this)">
                <i class="bi bi-clipboard"></i> Copy
            </a>
        </div>`;


        bubbleContent += formattedTime;

        const bubble = `<div class="message-bubble bg-light p-2 rounded" style="max-width: 400px; word-break: break-word;">${bubbleContent}</div>`;
        messageDiv.innerHTML = avatar + bubble;

        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function copyFromElement(el) {
        const content = el.getAttribute("data-copy");
        const type = el.getAttribute("data-type");
        const fileName = el.getAttribute("data-filename");

        copyMessage(content, type, fileName);
    }

    function copyMessage(content, type, fileName = '') {
        let toCopy = '';

        if (type === 'text') {
            toCopy = content;
        } else if (type === 'file') {
            toCopy = `[File] ${fileName}`;
        } else if (content.startsWith("data:image")) {
            toCopy = "[Image]";
        } else {
            toCopy = "[Unsupported]";
        }

        navigator.clipboard.writeText(toCopy)
            .then(() => showToast("ƒê√£ sao ch√©p n·ªôi dung"))
            .catch(err => showToast("Kh√¥ng th·ªÉ sao ch√©p"));
    }


    function getIconForMimeType(mime) {
        if (!mime) return "bi-file-earmark";

        if (mime.includes("pdf")) return "bi-file-earmark-pdf text-danger";
        if (mime.includes("zip") || mime.includes("rar")) return "bi-file-earmark-zip text-secondary";
        if (mime.includes("word")) return "bi-file-earmark-word text-primary";
        if (mime.includes("excel")) return "bi-file-earmark-excel text-success";
        if (mime.includes("powerpoint")) return "bi-file-earmark-ppt text-warning";
        if (mime.includes("text")) return "bi-file-earmark-text";
        if (mime.includes("image")) return "bi-file-earmark-image text-info";
        if (mime.includes("audio")) return "bi-file-earmark-music text-muted";
        if (mime.includes("video")) return "bi-file-earmark-play text-muted";

        return "bi-file-earmark"; // default
    }

    let currentReactMsgId = null;

    function reactToMessage(messageId, event) {
        currentReactMsgId = messageId;

        const popup = document.getElementById("emoji-popup");
        const rect = event.target.getBoundingClientRect();

        // Hi·ªÉn th·ªã popup ·ªü g·∫ßn v·ªã tr√≠ click
        popup.style.top = `${rect.bottom + window.scrollY}px`;
        popup.style.left = `${rect.left + window.scrollX}px`;
        popup.style.display = "block";
    }

    function sendReaction(emoji) {
        console.log("HELLO")
        const room = document.getElementById("room").value;
        const messageId = currentReactMsgId;
        console.log(room, messageId)
        if (!messageId || !room) return;

        fetch(`/react/${room}/${messageId}?emoji=${encodeURIComponent(emoji)}`, {
            method: "POST"
        }).then(response => {
            if (!response.ok) showToast("React th·∫•t b·∫°i", true);
        });

        // ·∫®n popup sau khi ch·ªçn
        document.getElementById("emoji-popup").style.display = "none";
        currentReactMsgId = null;
    }

    // ·∫®n popup khi click ra ngo√†i
    document.addEventListener("click", function (e) {
        const popup = document.getElementById("emoji-popup");
        if (!popup.contains(e.target) && !e.target.closest(".text-muted, .text-primary, .bi-emoji-smile")) {
            popup.style.display = "none";
            currentReactMsgId = null;
        }
    });


    // G√°n m√†u theo t√™n c·ªë ƒë·ªãnh (h√†m bƒÉm ƒë∆°n gi·∫£n)
    function getColor(sender) {
        const colors = [
            "#e6194b", "#3cb44b", "#ffe119", "#4363d8", "#f58231",
            "#911eb4", "#46f0f0", "#f032e6", "#bcf60c", "#fabebe"
        ];
        let hash = 0;
        for (let i = 0; i < sender.length; i++) {
            hash = sender.charCodeAt(i) + ((hash << 5) - hash);
        }
        return colors[Math.abs(hash) % colors.length];
    }

    function notify(msg) {
        if (Notification.permission === "granted") {
            new Notification(msg);
        } else if (Notification.permission !== "denied") {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    new Notification(msg);
                }
            });
        }
    }
</script>
<script>
    let originalTitle = document.title;
    let blinkInterval = null;
    let isWindowActive = true;

    // Reset khi quay l·∫°i tab
    window.addEventListener("focus", () => {
        isWindowActive = true;
        stopTitleBlinking();
    });

    // Khi r·ªùi tab
    window.addEventListener("blur", () => {
        isWindowActive = false;
    });

    function notifyNewMessage(sender) {
        if (!isWindowActive && !blinkInterval) {
            let toggle = false;
            blinkInterval = setInterval(() => {
                document.title = toggle ? "üîî Tin nh·∫Øn m·ªõi t·ª´ " + sender : originalTitle;
                toggle = !toggle;
            }, 1000);
        }
    }

    function stopTitleBlinking() {
        if (blinkInterval) {
            clearInterval(blinkInterval);
            blinkInterval = null;
            document.title = originalTitle;
        }
    }
</script>

<script>
    const emojiBtn = document.getElementById("emoji-btn");
    const picker = document.getElementById("emoji-picker");
    const input = document.getElementById("message");
    const emojiContainer = document.getElementById("emoji-container");

    // N·∫°p nhi·ªÅu emoji h∆°n
    const emojis = ["üòÄ", "üòÅ", "üòÇ", "ü§£", "üòÉ", "üòÑ", "üòÖ", "üòÜ", "üòâ", "üòä", "üòã", "üòç", "üòò", "üòó", "üòô", "üòö",
        "üòú", "üòù", "ü§™", "ü§®", "üßê", "ü§ì", "üòé", "ü•≥", "üò§", "üò¢", "üò≠", "üò±", "üò®", "üò∞", "üò°", "ü§¨",
        "ü•∂", "ü•µ", "ü§Ø", "üòá", "ü§†", "ü§°", "üëª", "üíÄ", "‚ò†Ô∏è", "üëΩ", "üëæ", "üéÉ", "üò∫", "üò∏", "üòπ", "üòª",
        "üòº", "üòΩ", "üôÄ", "üòø", "üòæ", "üëê", "üôå", "üëè", "üôè", "üí™", "ü§ù", "üëç", "üëé", "üëä", "‚úåÔ∏è", "ü§û", "ü§ü"];

    emojiContainer.innerHTML = emojis.map(e => `<span class="emoji">${e}</span>`).join("");

    // Toggle emoji panel
    emojiBtn.addEventListener("click", (e) => {
        picker.style.display = picker.style.display === "none" ? "block" : "none";
        e.stopPropagation();
    });

    // Insert emoji into input at cursor position
    emojiContainer.addEventListener("click", (e) => {
        if (e.target.classList.contains("emoji")) {
            const emoji = e.target.textContent;
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const text = input.value;
            input.value = text.substring(0, start) + emoji + text.substring(end);
            input.setSelectionRange(start + emoji.length, start + emoji.length);
            input.focus();
            // kh√¥ng ·∫©n picker ƒë·ªÉ ti·∫øp t·ª•c ch·ªçn th√™m emoji
        }
    });

    // ƒê√≥ng picker n·∫øu click ra ngo√†i
    document.addEventListener("click", function (e) {
        if (!emojiBtn.contains(e.target) && !picker.contains(e.target)) {
            picker.style.display = "none";
        }
    });

    function showToast(message, isError = false) {
        const toastEl = document.getElementById('custom-toast');
        const toastBody = document.getElementById('toast-message');

        toastBody.innerText = message;

        if (isError) {
            toastEl.classList.remove('bg-info', 'bg-success');
            toastEl.classList.add('bg-danger', 'text-white');
        } else {
            toastEl.classList.remove('bg-danger');
            toastEl.classList.add('bg-info', 'text-dark');
        }

        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }

    function appendNotification(message, type = "danger") {
        const list = document.getElementById("notification-list");

        const li = document.createElement("li");
        li.className = `list-group-item list-group-item-${type}`;
        li.textContent = message;

        list.prepend(li);
        if (list.children.length > 50) {
            list.removeChild(list.lastChild);
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
        const allForms = document.querySelectorAll('form');
        allForms.forEach(form => {
            form.addEventListener('submit', () => {
                showGlobalSpinner()
            });
        });
    });

    document.addEventListener('DOMContentLoaded', () => {
        const overlay = document.getElementById('loading-overlay');
        const navLinks = document.querySelectorAll('a.nav-link');

        navLinks.forEach(link => {
            link.addEventListener('click', function (e) {
                const href = link.getAttribute('href');
                if (href && !href.startsWith('#') && !href.startsWith('javascript')) {
                    showGlobalSpinner()
                }
            });
        });
    });

    function showGlobalSpinner() {
        const el = document.getElementById("global-loading-indicator");
        el.style.display = "block";
        setTimeout(() => el.style.opacity = "1", 10);
    }

    function hideGlobalSpinner() {
        const el = document.getElementById("global-loading-indicator");
        el.style.opacity = "0";
        setTimeout(() => el.style.display = "none", 300);
    }
</script>
</body>
</html>

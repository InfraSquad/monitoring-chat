<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Chat Room</title>
    <link href="/webjars/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-5">

<h2>üó®Ô∏è Realtime Chat Room</h2>

<div class="mb-3">
    <input type="text" id="nickname" class="form-control" placeholder="Enter your nickname">
</div>
<div class="mb-3">
    <input type="text" id="room" class="form-control" placeholder="Enter room name">
</div>
<div class="mb-3">
    <button onclick="connect()" class="btn btn-success">Join Room</button>
</div>

<div class="card">
    <div class="card-body" id="chat-box" style="height: 300px; overflow-y: auto; background: #f5f5f5">
        <div th:each="msg : ${history}" th:text="${msg.sender + ': ' + msg.content}"></div>
    </div>
</div>


<div class="input-group mt-3">
    <input type="text" id="message" class="form-control" placeholder="Type a message">
    <button onclick="sendMessage()" class="btn btn-primary">Send</button>
</div>

<script src="/webjars/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="/webjars/stomp-websocket/2.3.4/stomp.min.js"></script>
<script>
    let stompClient = null;
    let currentRoom = "";

    let connected = false;

    // Helper: L·∫•y query param t·ª´ URL
    function getQueryParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
    }

    document.addEventListener("DOMContentLoaded", () => {
        const roomInput = document.getElementById("room");
        const urlRoom = getQueryParam("room");
        const savedRoom = localStorage.getItem("chatRoom");

        // ∆Øu ti√™n room tr√™n URL, n·∫øu kh√¥ng c√≥ th√¨ d√πng localStorage
        if (urlRoom) {
            roomInput.value = urlRoom;
            localStorage.setItem("chatRoom", urlRoom); // l∆∞u l·∫°i cho l·∫ßn sau
        } else if (savedRoom) {
            roomInput.value = savedRoom;
        }
    });

    function connect() {
        if (connected) return; // tr√°nh g·ªçi l·∫°i connect nhi·ªÅu l·∫ßn

        const nickname = document.getElementById("nickname").value;
        const room = document.getElementById("room").value;
        currentRoom = room;

        localStorage.setItem("chatRoom", room); // l∆∞u l·∫°i ph√≤ng
        history.pushState(null, "", `/chat?room=${encodeURIComponent(room)}`);

        const socket = new SockJS("/ws");
        stompClient = Stomp.over(socket);
        stompClient.connect({}, () => {

            // // G·ª≠i tin nh·∫Øn ch√†o m·ª´ng
            stompClient.send(`/app/chat/${room}`, {}, JSON.stringify({
                sender: "System",
                content: `${nickname} has joined the room!`,
                room: room
            }));

            stompClient.subscribe(`/topic/${room}`, (message) => {
                const msg = JSON.parse(message.body);
                showMessage(msg.content, msg.sender);

                if (msg.sender !== nickname) {
                    notify("New message from " + msg.sender);
                }
            });

            connected = true; // ƒë√°nh d·∫•u ƒë√£ k·∫øt n·ªëi
        });
    }

    document.getElementById("message").addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
            sendMessage();
            event.preventDefault();
        }
    });

    function sendMessage() {
        const content = document.getElementById("message").value.trim();
        const sender = document.getElementById("nickname").value;
        const room = document.getElementById("room").value;

        if (!content || !sender || !room) return; // kh√¥ng g·ª≠i n·∫øu thi·∫øu

        stompClient.send(`/app/chat/${room}`, {}, JSON.stringify({
            sender: sender,
            content: content,
            room: room
        }));

        document.getElementById("message").value = "";
    }

    function showMessage(text, sender) {
        const chatBox = document.getElementById("chat-box");

        const messageDiv = document.createElement("div");
        messageDiv.innerHTML = `<strong style="color: ${getColor(sender)}">${sender}</strong>: ${text}`;
        messageDiv.className = "mb-1";
        chatBox.appendChild(messageDiv);

        chatBox.scrollTop = chatBox.scrollHeight; // auto scroll
    }

    // G√°n m√†u theo t√™n c·ªë ƒë·ªãnh (h√†m bƒÉm ƒë∆°n gi·∫£n)
    function getColor(sender) {
        const colors = [
            "#e6194b", "#3cb44b", "#ffe119", "#4363d8", "#f58231",
            "#911eb4", "#46f0f0", "#f032e6", "#bcf60c", "#fabebe"
        ];
        let hash = 0;
        for (let i = 0; i < sender.length; i++) {
            hash = sender.charCodeAt(i) + ((hash << 5) - hash);
        }
        return colors[Math.abs(hash) % colors.length];
    }

    function notify(msg) {
        if (Notification.permission === "granted") {
            new Notification(msg);
        } else if (Notification.permission !== "denied") {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    new Notification(msg);
                }
            });
        }
    }
</script>
</body>
</html>
